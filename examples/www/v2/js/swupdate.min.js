/*!
 * Copyright (C) 2017-2018 Weidm√ºller Interface GmbH & Co. KG
 * Stefan Herbrechtsmeier <stefan.herbrechtsmeier@weidmueller.com>
 *
 * SPDX-License-Identifier: MIT
 */
const StatusEnum={IDLE:"IDLE",START:"START",RUN:"RUN",SUCCESS:"SUCCESS",FAILURE:"FAILURE",DONE:"DONE"};function isStatusInEnum(s){return s in StatusEnum}function restart(){$.post("restart",{},function(s){showRestart()})}function showRestart(){$("#swu-restart-modal").modal({backdrop:"static",keyboard:!1}),window.setTimeout(tryReload,3e3)}function tryReload(){$.ajax({cache:!1,timeout:1e3,success:function(s){window.location.reload(!0)},error:function(s,e,a){"timeout"===e?tryReload():window.setTimeout(tryReload,1e3)}})}function updateStatus(s){if(isStatusInEnum(s))switch($("#swu-idle").hide(),$("#swu-success").hide(),$("#swu-failure").hide(),$("#swu-done").hide(),$("#swu-run").hide(),s){case StatusEnum.IDLE:$("#swu-idle").show();break;case StatusEnum.START:case StatusEnum.RUN:$("#swu-run").show();break;case StatusEnum.SUCCESS:$("#swu-success").show();break;case StatusEnum.FAILURE:$("#swu-failure").show();break;case StatusEnum.DONE:$("#swu-done").show()}}var updateProgressBarStatus=function(s){var e="";return function(s){if(isStatusInEnum(s)){switch($("#swu-progress-bar").removeClass("bg-danger bg-success progress-bar-animated"),$("#swu-progress-spinner").removeClass("fa-spinner fa-spin"),$("#swu-progress-run").hide(),s){case StatusEnum.START:updateProgressBar(0,"","");break;case StatusEnum.RUN:$("#swu-progress-bar").addClass("progress-bar-animated"),$("#swu-progress-spinner").addClass("fa-spinner fa-spin"),$("#swu-progress-run").show();break;case StatusEnum.SUCCESS:$("#swu-progress-bar").addClass("bg-success");break;case StatusEnum.FAILURE:"START"===e&&"RUN"===e||updateProgressBar(0,"",""),$("#swu-progress-bar").addClass("bg-danger")}e=s}}}();function updateProgressBar(s,e,a){$("#swu-progress-value").text(a),$("#swu-progress-name").text(e),$("#swu-progress-bar").css("width",s+"%").attr("aria-valuenow",s)}Dropzone.options.dropzone={timeout:0,clickable:!0,acceptedFiles:".swu",maxFilesize:0},window.onload=function(){var s;$("#swu-restart").click(restart),s="https:"===window.location.protocol?"wss:":"ws:";var e=new WebSocket(s+"//"+window.location.host+window.location.pathname.replace(/\/[^\/]*$/,"")+"/ws");e.onopen=function(s){updateStatus(StatusEnum.IDLE)},e.onclose=function(s){showRestart()},e.onmessage=function(s){var e=JSON.parse(s.data);switch(e.type){case"message":var a=$("<p></p>");a.text(e.text),a.addClass("mb-1"),e.level<=3&&a.addClass("text-danger"),$("#messages").append(a);break;case"status":updateStatus(e.status),updateProgressBarStatus(e.status);break;case"source":break;case"step":var t=Math.round((100*(Number(e.step)-1)+Number(e.percent))/Number(e.number)),r=t+"% ("+e.step+" of "+e.number+")";updateProgressBar(t,e.name,r)}}};